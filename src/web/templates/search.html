{% extends "base.html" %}

{% block title %}Search Memories - C.H.R.I.S.T.{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Search Memories</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Search Box -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="search-form">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg" id="search-query"
                               placeholder="Search your memories..." autofocus>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="time-range">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Source Type</label>
                            <select class="form-select" id="source-type">
                                <option value="">All Types</option>
                                <option value="email">Email</option>
                                <option value="chat">Chat</option>
                                <option value="document">Documents</option>
                                <option value="journal">Journal</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Results</label>
                            <select class="form-select" id="result-limit">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results">
            <div class="text-center text-muted py-5">
                <h5>Enter a search query to find memories</h5>
                <p>You can search for keywords, people, places, or concepts</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- AI Question Box -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Ask a Question</h5>
            </div>
            <div class="card-body">
                <form id="question-form">
                    <div class="mb-3">
                        <textarea class="form-control" id="question" rows="3"
                                  placeholder="Ask anything about your memories..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Get Answer</button>
                </form>
                <div id="answer-box" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6>Answer:</h6>
                        <p id="answer-text"></p>
                        <small class="text-muted" id="answer-sources"></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Searches -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Saved Searches</h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="saved-searches">
                    <a href="#" class="list-group-item list-group-item-action" onclick="runSearch('work projects')">
                        Work Projects
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="runSearch('family events')">
                        Family Events
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="runSearch('travel memories')">
                        Travel Memories
                    </a>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="saveCurrentSearch()">
                    Save Current Search
                </button>
            </div>
        </div>

        <!-- Search Tips -->
        <div class="card">
            <div class="card-header">
                <h5>Search Tips</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Use quotes for exact phrases: "team meeting"</li>
                    <li>Combine terms: vacation AND beach</li>
                    <li>Exclude terms: coffee -starbucks</li>
                    <li>Search by person: from:john@example.com</li>
                    <li>Search by date: after:2024-01-01</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Search form
    document.getElementById('search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await performSearch();
    });

    async function performSearch() {
        const query = document.getElementById('search-query').value;
        const limit = document.getElementById('result-limit').value;

        if (!query) {
            alert('Please enter a search query');
            return;
        }

        try {
            const response = await axios.post('/api/v1/retrieval/search', {
                query: query,
                k: parseInt(limit),
                use_hybrid: true
            });

            displayResults(response.data.results);
        } catch (error) {
            console.error('Search error:', error);
            document.getElementById('search-results').innerHTML = `
                <div class="alert alert-danger">
                    Error performing search: ${error.message}
                </div>
            `;
        }
    }

    function displayResults(results) {
        if (!results || results.length === 0) {
            document.getElementById('search-results').innerHTML = `
                <div class="alert alert-warning">
                    No results found. Try different keywords or broaden your search.
                </div>
            `;
            return;
        }

        const html = results.map(result => `
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        ${result.metadata?.source || 'Unknown Source'} -
                        ${result.metadata?.timestamp ? new Date(result.metadata.timestamp).toLocaleDateString() : 'Unknown Date'}
                    </h6>
                    <p class="card-text">${highlightText(result.document)}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Relevance: ${(result.score * 100).toFixed(1)}%</small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetail('${result.id}')">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        document.getElementById('search-results').innerHTML = `
            <h5 class="mb-3">Found ${results.length} results</h5>
            ${html}
        `;
    }

    function highlightText(text) {
        const query = document.getElementById('search-query').value;
        if (!query) return text;

        const regex = new RegExp(`(${query})`, 'gi');
        return text.substring(0, 500).replace(regex, '<mark>$1</mark>') +
               (text.length > 500 ? '...' : '');
    }

    // Question form
    document.getElementById('question-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const question = document.getElementById('question').value;
        if (!question) {
            alert('Please enter a question');
            return;
        }

        try {
            document.getElementById('answer-box').style.display = 'block';
            document.getElementById('answer-text').textContent = 'Thinking...';

            const response = await axios.post('/api/v1/retrieval/ask', question, {
                headers: { 'Content-Type': 'text/plain' },
                params: { use_context: true, k: 5 }
            });

            document.getElementById('answer-text').textContent = response.data.answer;

            if (response.data.sources && response.data.sources.length > 0) {
                document.getElementById('answer-sources').textContent =
                    `Based on ${response.data.sources.length} sources`;
            }
        } catch (error) {
            document.getElementById('answer-text').textContent =
                'Error getting answer: ' + error.message;
        }
    });

    function runSearch(query) {
        document.getElementById('search-query').value = query;
        performSearch();
    }

    function saveCurrentSearch() {
        const query = document.getElementById('search-query').value;
        if (!query) {
            alert('No search to save');
            return;
        }

        const name = prompt('Name for this saved search:', query);
        if (name) {
            // TODO: Save to backend
            alert(`Saved search: ${name}`);
        }
    }

    function viewDetail(id) {
        // TODO: Open detail view
        alert(`View details for: ${id}`);
    }
</script>
{% endblock %}